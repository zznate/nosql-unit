<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;1.&nbsp;MongoDb Engine</title><link rel="stylesheet" type="text/css" href="stylesheet.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter" title="Chapter&nbsp;1.&nbsp;MongoDb Engine"><div class="titlepage"><div><div><h2 class="title"><a name="mongodb"></a>Chapter&nbsp;1.&nbsp;MongoDb Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d264e4">MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#d264e71">Maven Setup</a></span></dt><dt><span class="section"><a href="#d264e143">Dataset Format</a></span></dt><dt><span class="section"><a href="#d264e166">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="MongoDb"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d264e4"></a>MongoDb</h2></div></div></div><p>
			<span class="application">MongoDb</span>
			is a
			<span class="emphasis"><em>NoSQL</em></span>
			database that stores structured data as
			<span class="emphasis"><em>JSON-like</em></span>
			documents with dynamic schemas.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>MongoDb</em></span>
			by using next classes:
		</p><p>
		</p><table border="1" id="d264e28"><caption>Table&nbsp;1.1.&nbsp;Lifecycle Management Rules</caption><tr>
				<td>In Memory</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDb
					</code>
				</td>
			</tr><tr>
				<td>Managed</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb
					</code>
				</td>
			</tr></table><p>
		</p><p>
		</p><table border="1" id="d264e56"><caption>Table&nbsp;1.2.&nbsp;Manager Rule</caption><tr>
				<td>NoSQLUnit Management</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.MongoDbRule
					</code>
				</td>
			</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d264e71"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">MongoDb</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_dep"></a><p class="title"><b>Example&nbsp;1.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-mongodb<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"><p>
				Note that if you are plannig to use
				<span class="bold"><strong>in-memory</strong></span>
				approach an extra dependency is
				required.
				<span class="bold"><strong>In-memory</strong></span>
				mode is implemented
				using
				<span class="emphasis"><em>jmockmongo</em></span>
				.
				<span class="emphasis"><em>JMockmongo</em></span>
				is a new project that help with unit testing Java-based
				<span class="application">MongoDb</span>
				Applications by starting an
				in-process
				<span class="emphasis"><em>Netty</em></span>
				server that speaks the
				<span class="emphasis"><em>MongoDb</em></span>
				protocol and maintains databases and
				collections in
				<acronym class="acronym">JVM</acronym>
				memory. It is not a true embedded
				mode becuase it will starts a server, but in fact for now it is the best
				way to write
				<span class="application">MongoDb</span>
				unit tests. As his
				author says it is an incomplete tool and will be improved every time a
				new feature is required.
			</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					During development of this documentation, current
					<span class="emphasis"><em>jmockmongo</em></span>
					version was 0.0.2-SNAPSHOT. Author is
					imporoving version often so before using one specific version, take a
					look at its
					<a class="link" href="https://github.com/thiloplanz/jmockmongo" target="_top">website</a>
					.
				</p></div><p>
				To install add next
				<a class="link" href="#conf.jmockmongo_repo" title="Example&nbsp;1.2.&nbsp;jmockmongo Maven Repository">
					repository
				</a>
				and
				<a class="link" href="#conf.jmockmongo_dep" title="Example&nbsp;1.3.&nbsp;jmockmongo Maven Dependency">
					dependency
				</a>
				:
			</p><div class="example"><a name="conf.jmockmongo_repo"></a><p class="title"><b>Example&nbsp;1.2.&nbsp;jmockmongo Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;repositories&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;repository&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;id&gt;</strong>thiloplanz-snapshot<strong class="hl-tag" style="color: #000096">&lt;/id&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;url&gt;</strong>http://repository-thiloplanz.forge.cloudbees.com/snapshot/<strong class="hl-tag" style="color: #000096">&lt;/url&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;/repository&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/repositories&gt;</strong></pre></div></div><br class="example-break"><div class="example"><a name="conf.jmockmongo_dep"></a><p class="title"><b>Example&nbsp;1.3.&nbsp;jmockmongo Maven Dependency</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${mongomock.version}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d264e143"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>MongoDb</em></span>
				module
				is
				<span class="emphasis"><em>json</em></span>
				.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.mongodb_dataset" title="Example&nbsp;1.4.&nbsp;Example of MongoDb Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.mongodb_dataset"></a><p class="title"><b>Example&nbsp;1.4.&nbsp;Example of MongoDb Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"name_collection1": [
	{
		"attribute_1":"value1",
		"attribute_2":"value2"
	},
	{
		"attribute_3":2,
		"attribute_4":"value4"
	}
	],
	"name_collection2": [
		...
	],
	....
}</pre></div></div><br class="example-break"><p>Notice that if attributes value are integers, double quotes are
				not required.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d264e166"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d264e169"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you
					will require an
					<span class="bold"><strong>in-memory</strong></span>
					approach,
					<span class="bold"><strong>managed</strong></span>
					approach or
					<span class="bold"><strong>remote</strong></span>
					approach.
				</p><p>
					To configure
					<span class="bold"><strong>in-memory</strong></span>
					approach
					you should only instantiate next
					<a class="link" href="#program.inmemory_conf" title="Example&nbsp;1.5.&nbsp;In-memory MongoDb">rule</a>
					:
				</p><div class="example"><a name="program.inmemory_conf"></a><p class="title"><b>Example&nbsp;1.5.&nbsp;In-memory MongoDb</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
InMemoryMongoDb inMemoryMongoDb = <strong class="hl-keyword">new</strong> InMemoryMongoDb();</pre></div></div><br class="example-break"><p>
					To configure the
					<span class="bold"><strong>managed</strong></span>
					way,
					you should use
					<code class="classname">ManagedMongoDb</code>
					rule and may
					require some <a class="link" href="#program.managed_conf" title="Example&nbsp;1.6.&nbsp;Managed MongoDb">configuration</a> parameters.
				</p><div class="example"><a name="program.managed_conf"></a><p class="title"><b>Example&nbsp;1.6.&nbsp;Managed MongoDb</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().build();</pre></div></div><br class="example-break"><p>
					By default managed
					<span class="emphasis"><em>MongoDb</em></span>
					rule uses next
					default values:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>MongoDb</em></span>
							installation directory is
							retrieved from
							<code class="varname">MONGO_HOME</code>
							system environment
							variable.
						</p></li><li class="listitem"><p>
							Target path, that is the directory where
							<span class="emphasis"><em>MongoDb</em></span>
							server is started, is
							<code class="constant">target/mongo-temp</code>
							.
						</p></li><li class="listitem"><p>
							Database path is at
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/mongo-dbpath</code>
							.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>Mongodb</em></span>
							is started with
							<span class="emphasis"><em>fork</em></span>
							option.
						</p></li><li class="listitem"><p>
							Because after execution of tests all generated data is
							removed, in
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/logpath</code>
							will remain log
							file generated by the server.
						</p></li><li class="listitem"><p>
							In
							<span class="emphasis"><em>Windows</em></span> systems
							executable should be found as
							<code class="filename">bin/mongod.exe</code>
							meanwhile in
							<span class="emphasis"><em>MAC
								OS
							</em></span>
							and
							<span class="emphasis"><em>*nix</em></span>
							should be found as
							<code class="filename">bin/mongod</code>
							.
						</p></li></ul></div><p>
					<code class="classname">ManagedMongoDb</code>
					can be created from
					scratch, but for making life easier, a
					<span class="emphasis"><em>DSL</em></span>
					is
					provided using
					<code class="classname">MongoServerRuleBuilder</code>
					class.
					For
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;1.7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					:
				</p><div class="example"><a name="program.managed_specific_conf"></a><p class="title"><b>Example&nbsp;1.7.&nbsp;Specific Managed MongoDb Configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb =
newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).appendSingleCommandLineArguments(<strong class="hl-string"><em style="color:red">"-vvv"</em></strong>).build();</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;1.7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					we are overriding
					<code class="varname">MONGO_HOME</code>
					variable (in case has
					been set) and set mongo home at
					<code class="filename">/opt/mongo</code>
					.
					Moreover we are appending a single argument to
					<span class="emphasis"><em>MongoDb</em></span>
					executable, in this case setting log
					level to number 3 (-vvv). Also you can append
					<span class="emphasis"><em>property=value</em></span>
					arguments using
					<code class="function">appendCommandLineArguments(String argumentName, String
						argumentValue)
					</code>
					method.
				</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>when you are specifying command line arguments, remember to
						add slash (-) and double slash (--) where is necessary.
					</p></div><p>
					To stop
					<span class="emphasis"><em>MongoDb</em></span>
					instance,
					<span class="bold"><strong>NoSQLUnit</strong></span>
					sends a
					<code class="function">shutdown</code>
					command to server using
					<span class="emphasis"><em>Java Mongo AP</em></span>
					I. When this
					command is sent, the server is stopped and because connection is lost,
					<span class="emphasis"><em>Java Mongo API</em></span>
					logs automatically an exception
					(read
					<a class="link" href="https://groups.google.com/group/mongodb-user/browse_thread/thread/ac9a4c9ea13f3e81" target="_top">here</a>
					information about the problem and how to "resolve" it). Do not
					confuse
					with a testing failure. You will see something like:
				</p><pre class="screen">java.io.EOFException
	at org.bson.io.Bits.readFully(Bits.java:37)
	at org.bson.io.Bits.readFully(Bits.java:28)
	at com.mongodb.Response.&lt;init&gt;;(Response.java:39)
	at com.mongodb.DBPort.go(DBPort.java:128)
	at com.mongodb.DBPort.call(DBPort.java:79)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:218)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:305)
	at com.mongodb.DB.command(DB.java:160)
	at com.mongodb.DB.command(DB.java:183)
	at com.mongodb.DB.command(DB.java:144)
	at
	com.lordofthejars.nosqlunit.mongodb.MongoDbLowLevelOps.shutdown(MongoDbLowLevelOps.java:44)
	at
	com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.after(ManagedMongoDb.java:157)
	at
	org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
	at org.junit.rules.RunRules.evaluate(RunRules.java:18)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:236)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:134)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:113)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at
	sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at
	sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:616)
	at
	org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at
	org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at
	org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at
	org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:103)
	at
	org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:74)</pre><p>
					Configuring
					<span class="bold"><strong>remote</strong></span>
					approach
					does not require any special rule because you (or System like
					<span class="application">Maven</span>
					) is the responsible of starting and
					stopping the server. This mode is used in deployment tests where you
					are testing your application on real environment.
				</p></div><div class="section" title="Configuring MongoDb Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d264e353"></a>Configuring MongoDb Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="emphasis"><em>
						<span class="bold"><strong>Mongodb</strong></span>
					</em></span>
					rule in charge of
					maintaining
					<span class="emphasis"><em>MongoDb</em></span>
					database into known state by
					inserting and deleting defined datasets. You must register
					<code class="classname">MongoDbRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule
					class, which requires a configuration parameter with information like
					host, port or database name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects. Two
					different kind of configuration builders exist.
				</p><p>
					The first one is for configuring a connection to in-memory
					<span class="emphasis"><em>jmockmongo</em></span>
					server. Default connection values
					are:
				</p><table border="1" id="d264e380"><caption>Table&nbsp;1.3.&nbsp;Default In-Memory Configuration Values</caption><tr>
						<td>Host</td>

						<td>0.0.0.0</td>
					</tr><tr>
						<td>Port</td>

						<td>2307</td>
					</tr></table><p>
					Notice that these values are the default ones of
					<span class="emphasis"><em>jmockmongo</em></span>
					project, so if you are thinking to use
					<span class="emphasis"><em>jmockmongo</em></span>
					, no modifications are required.
				</p><div class="example"><a name="program.in_memory_connection_parameters"></a><p class="title"><b>Example&nbsp;1.8.&nbsp;MongoDbRule with in-memory configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDbConfigurationBuilder.inMemoryMongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(inMemoryMongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><p>
					The second one is for configuring a connection to remote
					<span class="emphasis"><em>MongoDb</em></span>
					server. Default values are:
				</p><table border="1" id="d264e417"><caption>Table&nbsp;1.4.&nbsp;Default Managed Configuration Values</caption><tr>
						<td>Host</td>

						<td>localhost</td>
					</tr><tr>
						<td>Port</td>

						<td>27017</td>
					</tr><tr>
						<td>Authentication</td>

						<td>No authentication parameters.</td>
					</tr></table><div class="example"><a name="program.managed_connection_parameters"></a><p class="title"><b>Example&nbsp;1.9.&nbsp;MongoDbRule with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><div class="example"><a name="program.remote_connection_parameters"></a><p class="title"><b>Example&nbsp;1.10.&nbsp;MongoDbRule with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).host(<strong class="hl-string"><em style="color:red">"my_remote_host"</em></strong>).build());</pre></div></div><br class="example-break"></div><div class="section" title="Complete Example"><div class="titlepage"><div><div><h4 class="title"><a name="d264e454"></a>Complete Example</h4></div></div></div><p>
					Consider a library application, which apart from multiple
					operations, it allow us to add new books to system. Our
					<a class="link" href="#example.book_model" title="Example&nbsp;1.11.&nbsp;Book POJO">model</a>
					is as simple as:
				</p><div class="example"><a name="example.book_model"></a><p class="title"><b>Example&nbsp;1.11.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> Book {

	<strong class="hl-keyword">private</strong> String title;

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">int</strong> numberOfPages;

	<strong class="hl-keyword">public</strong> Book(String title, <strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">super</strong>();
		<strong class="hl-keyword">this</strong>.title = title;
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setTitle(String title) {
		<strong class="hl-keyword">this</strong>.title = title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setNumberOfPages(<strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}


	<strong class="hl-keyword">public</strong> String getTitle() {
		<strong class="hl-keyword">return</strong> title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> getNumberOfPages() {
		<strong class="hl-keyword">return</strong> numberOfPages;
	}
}</pre></div></div><br class="example-break"><p>
					Next business
					<a class="link" href="#example.book_manager" title="Example&nbsp;1.12.&nbsp;Book POJO">class</a>
					is the responsible of managing access to
					<span class="emphasis"><em>MongoDb</em></span>
					server:
				</p><div class="example"><a name="example.book_manager"></a><p class="title"><b>Example&nbsp;1.12.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> BookManager {

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> Logger LOGGER = LoggerFactory.getLogger(BookManager.<strong class="hl-keyword">class</strong>);

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> MongoDbBookConverter MONGO_DB_BOOK_CONVERTER = <strong class="hl-keyword">new</strong>	MongoDbBookConverter();
	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> DbObjectBookConverter DB_OBJECT_BOOK_CONVERTER = <strong class="hl-keyword">new</strong> DbObjectBookConverter();

			
	<strong class="hl-keyword">private</strong> DBCollection booksCollection;

	<strong class="hl-keyword">public</strong> BookManager(DBCollection booksCollection) {
		<strong class="hl-keyword">this</strong>.booksCollection = booksCollection;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> create(Book book) {
		DBObject dbObject = MONGO_DB_BOOK_CONVERTER.convert(book);
		booksCollection.insert(dbObject);
	}
}</pre></div></div><br class="example-break"><p>
					And now it is time for testing. In next
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;1.13.&nbsp;Test with Managed Connection">test</a>
					we are going to
					validate that a book is inserted correctly into database.
				</p><div class="example"><a name="example.test_insert_book"></a><p class="title"><b>Example&nbsp;1.13.&nbsp;Test with Managed Connection</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">package</strong> com.lordofthejars.nosqlunit.demo.mongodb;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenANewBookIsCreated {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).build();

	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="initialData.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<em><span class="hl-annotation" style="color: gray">@ShouldMatchDataSet(location="expectedData.json")</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> book_should_be_inserted_into_repository() {

		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(MongoDbUtil.getCollection(Book.<strong class="hl-keyword">class</strong>.getSimpleName()));

		Book book = <strong class="hl-keyword">new</strong> Book(<strong class="hl-string"><em style="color:red">"The Lord Of The Rings"</em></strong>, <span class="hl-number">1299</span>);
		bookManager.create(book);
	}

}</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;1.13.&nbsp;Test with Managed Connection">previous</a>
					test
					we have defined that
					<span class="emphasis"><em>MongoDb</em></span>
					will be managed by
					test by starting an instance of server located at
					<code class="filename">/opt/mongo</code>
					. Moreover we are setting an
					<a class="link" href="#example.dataset_book" title="Example&nbsp;1.14.&nbsp;Initial Dataset">initial</a>
					dataset in file
					<code class="filename">initialData.json</code>
					located at classpath
					<code class="filename">com/lordofthejars/nosqlunit/demo/mongodb/initialData.json
					</code>
					and
					<a class="link" href="#example.expected_dataset_book" title="Example&nbsp;1.15.&nbsp;Expected Dataset">expected</a>
					dataset called
					<code class="filename">expectedData.json</code>
					.
				</p><div class="example"><a name="example.dataset_book"></a><p class="title"><b>Example&nbsp;1.14.&nbsp;Initial Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293}
	]
}</pre></div></div><br class="example-break"><div class="example"><a name="example.expected_dataset_book"></a><p class="title"><b>Example&nbsp;1.15.&nbsp;Expected Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293},
		{"title":"The Lord Of The Rings","numberOfPages":1299}
	]
}</pre></div></div><br class="example-break"><p>
					You can watch full example at
					<a class="link" href="https://github.com/lordofthejars/nosql-unit/tree/master/nosqlunit-demo" target="_top">github</a>
					.
				</p></div></div></div></div></body></html>